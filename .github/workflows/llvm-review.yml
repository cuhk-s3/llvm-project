name: LLVM Review

permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: write

on:
  pull_request:
    types: [opened, synchronize, reopened, review_requested, ready_for_review]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    container: cardigan1008/comptest-env:latest
    steps:
      - name: Checkout CI code
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            .github
            .ci
      
      - name: Set up .claude/settings.json
        shell: bash
        run: |
          mkdir -p ~/.claude
          cp .ci/claude/settings.json ~/.claude/settings.json

      - name: Checkout LLVM source (PR Head)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          path: llvm-project
          fetch-depth: 0

      - name: Fetch base objects from upstream
        shell: bash
        run: |
          cd llvm-project
          git remote add upstream https://github.com/llvm/llvm-project.git
          git fetch --no-tags upstream ${{ github.event.pull_request.base.sha }}
          git fetch --no-tags upstream ${{ github.event.pull_request.base.ref }}

      - name: Index LLVM source
        shell: bash
        run: |
          cd llvm-project
          semcode-index --source .

      - name: Build opt (from PR source)
        shell: bash
        run: |
          mkdir -p llvm-project/build
          cd llvm-project/build
          # Configure for minimal build (just LLVM, no Clang/Tools/etc to save time)
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_TARGETS_TO_BUILD="X86" \
            -DLLVM_ENABLE_PROJECTS="" \
            ../llvm
          # Only build the 'opt' tool
          ninja opt
          echo "OPT_PATH=$(pwd)/bin/opt" >> $GITHUB_ENV

      - name: Checkout CompPrompt
        uses: actions/checkout@v4
        with:
          repository: 'cuhk-s3/CompPrompt'
          path: CompPrompt
      
      - name: Run CompPrompt Setup
        shell: bash
        run: |
          cd CompPrompt
          chmod +x scripts/claude_setup.sh
          ./scripts/claude_setup.sh

      - name: Checkout CI Scripts
        uses: actions/checkout@v4
        with:
          path: ci-scripts

      - name: Run Claude Agent
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_bedrock: "true"
          claude_args: '--max-turns 10 --model us.anthropic.claude-opus-4-5-20251101-v1:0'
          prompt: |
            You are an expert LLVM Compiler Engineer.
            
            Current directory is the root of the 'llvm-project' repository.
            
            The 'opt' tool built from the PR source is located at: llvm-project/build/bin/opt
            
            Read the prompt at 'CompPrompt/prompts/review-core.md'.
            
            Using the prompt, do a deep dive regression analysis of the HEAD commit.
            
            Use commit range ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} for the false-positive-guide.md section.

      # Reporting Logic
      - name: Check for Findings
        id: check_review
        shell: bash
        run: |
          # Check for review text
          if [ -f "llvm-project/review-inline.txt" ]; then
              echo "found_review=true" >> $GITHUB_OUTPUT
              echo "review_path=llvm-project/review-inline.txt" >> $GITHUB_OUTPUT
          fi
          
          # Check for generated tests
          if [ -f "llvm-project/miscompilation_test.ll" ]; then
              echo "found_test=true" >> $GITHUB_OUTPUT
          fi

      - name: Post Review Comment
        if: steps.check_review.outputs.found_review == 'true'
        uses: actions/github-script@v7
        env:
          REVIEW_FILE: ${{ steps.check_review.outputs.review_path }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const fs = require('fs');
            // Adjust path to point to the script in the current workspace context
            const scriptPath = './ci-scripts/ci/scripts/post-pr-comment.js';
            const postComment = require(scriptPath);
            await postComment({github, context, fs});

      - name: Upload Test Case Artifact
        if: steps.check_review.outputs.found_test == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: reproduced-miscompilation
          path: llvm-project/miscompilation_test.ll